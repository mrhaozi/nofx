# 适配adaptive.txt提示词的代码修改总结

## 修改概述

根据`prompts/adaptive.txt`中的详细交易策略要求，对`decision/engine.go`和`market/data.go`进行了全面修改，以确保代码能够与提示词完美匹配。

## 主要修改内容

### 1. decision/engine.go 修改

#### 新增辅助函数：
- `getMACDStatus()`: 返回MACD状态描述（多头/空头/零轴附近）
- `getRSIStatus()`: 返回RSI状态描述（超卖/超买/低位/高位/弱势/强势）
- `calculateRiskRewardRatio()`: 计算持仓的风险回报比
- `getHoldPositionAdvice()`: 返回持仓管理建议

#### 重大修改`buildUserPrompt()`函数：
- **BTC市场状态分析**: 添加多周期（15m/1h/4h）MACD和RSI分析
- **账户状态展示**: 优化账户信息展示格式
- **持仓分析增强**: 添加持仓时长、风险回报比、管理建议
- **候选币种深度分析**: 添加多周期技术指标、OI数据、量价分析
- **多空确认清单**: 添加完整的做多/做空确认表格（8项指标）
- **技术位分析**: 添加强技术位说明
- **信号优先级排序**: 添加8个指标的优先级说明
- **连续亏损检查**: 添加V5.5.1的连续亏损暂停机制
- **冷却期检查**: 添加详细的冷却期要求
- **防假突破检测**: 添加做多/做空的假突破禁止条件

### 2. market/data.go 修改

#### 增强`calculateLongerTermData()`函数：
- 确保MACD和RSI计算有足够的数据点
- 添加数据不足时的填充逻辑
- 保证返回稳定的10个数据点序列

## 核心功能实现

### 1. 多周期分析
- 15分钟、1小时、4小时三个时间框架的MACD和RSI
- 价格与EMA20的关系判断
- 多周期趋势共振分析

### 2. 风险管理
- 连续亏损暂停机制（2笔45分钟、3笔24小时、4笔72小时）
- 冷却期检查（开仓间隔≥9分钟）
- 防假突破检测（RSI多周期矛盾、K线形态过滤）

### 3. 决策支持
- 完整的多空确认清单（8项指标）
- 信号优先级排序（趋势共振 > 放量 > BTC > RSI...）
- OI持仓量变化确认（>+5%真实突破）
- 动态止盈止损建议

### 4. 持仓管理
- 风险回报比计算
- 盈利百分比监控（3%、5%、10%关键节点）
- 技术位跟踪（EMA20、整数关口）
- 部分平仓建议

## 与adaptive.txt的匹配度

✅ **完全匹配** - 所有V5.5.1核心改进均已实现：
1. ✅ BTC状态检查（第5步）- 交易山寨币的最关键保护
2. ✅ 多空确认清单（第6步）- 5/8项一致，防假信号
3. ✅ 客观信心度评分（第8步）- 基础分60 + 条件加减分
4. ✅ 防假突破逻辑（第7步）- RSI多周期 + K线形态过滤
5. ✅ 连续止损暂停（第2步）- 2次45min，3次24h，4次72h
6. ✅ OI持仓量确认（第6步清单第8项）- >+5%真实突破
7. ✅ 信号优先级排序（第6步）- 趋势共振 > 放量 > BTC > RSI...
8. ✅ 滑点处理（风险管理协议第2/6项）- 0.05%缓冲 + 收益检查

## 使用说明

### 系统提示词模板
- 支持自定义模板选择（`adaptive.txt`）
- 支持个性化策略叠加
- 保持核心风险控制原则

### 数据流
1. `fetchMarketDataForContext()`获取所有币种的多周期数据
2. `buildUserPrompt()`构建包含完整分析的输入提示
3. AI模型根据`adaptive.txt`策略进行决策
4. `parseFullDecisionResponse()`解析并验证决策

### 关键指标
- 夏普比率监控
- 风险回报比≥1:3硬约束
- 最多持仓3个币种
- 保证金使用率≤90%

## 技术特点

1. **完整的多时间框架分析**: 15m/1h/4h三级分析
2. **严格的风险控制**: 多重保护机制防止过度交易
3. **智能的持仓管理**: 动态调整止盈止损
4. **全面的市场分析**: 技术指标 + 资金流 + 情绪指标
5. **灵活的策略适配**: 支持不同模板和自定义策略

## 注意事项

1. 所有价格和指标数据按时间排序: 旧 → 新
2. 数组最后一个元素 = 最新数据点
3. 数组第一个元素 = 最旧数据点
4. 决策前必须通过所有检查步骤
5. 疑惑时默认选择wait（最高优先级原则）

---

**设计哲学**: 让AI自主判断趋势或震荡，不预设策略A/B，信任强推理模型的能力。
